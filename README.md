# Advanced Network System - Contrast Game

## 概要

このプロジェクトは、ネットワーク対戦型のボードゲーム「Contrast」のクライアント・サーバーシステムです。TCP/IPソケット通信を使用して、複数のプレイヤーがロビーでチャットしたり、対戦ルームを作成して1対1の対戦を行うことができます。

## システム構成

### サーバー (server/server.c)

**役割**: 複数のクライアント接続を管理し、ロビー機能とゲーム対戦の仲介を行う

**主な機能**:
- **接続管理**: 最大10クライアントの同時接続をサポート
- **ロビーシステム**: クライアント間でのメッセージのブロードキャスト
- **ルーム管理**: 対戦ルームの作成、参加、マッチング
- **ゲーム進行**: ゲーム状態の管理、手番の検証、勝敗判定
- **多重化I/O**: `select()`を使用した非ブロッキング通信

**技術仕様**:
- ポート番号: 10000
- プロトコル: TCP/IP
- 最大同時接続: 10クライアント
- 最大ルーム数: 5部屋（MAX_CLIENTS / 2）

**クライアント状態**:
1. `STATE_LOBBY` (1): ロビーでコマンド入力待ち
2. `STATE_WAITING` (2): 部屋を作成して対戦相手待ち
3. `STATE_PLAYING` (3): 対戦中

**サポートするコマンド**:

| コマンド | 形式 | 説明 |
|---------|------|------|
| SAY | `SAY <message>` | ロビーにいる全員にメッセージをブロードキャスト |
| LIST | `LIST` | 待機中の対戦ルームの一覧を表示 |
| CREATE | `CREATE <room_id>` | 新しい対戦ルームを作成(作成者は黒プレイヤー) |
| JOIN | `JOIN <room_id>` | 既存のルームに参加(参加者は白プレイヤー) |
| EXIT | `EXIT` | クライアントプログラムを終了 |

**動作フロー**:
1. クライアント接続時にロビー状態で待機
2. CREATEコマンドで部屋を作成し、WAITING状態へ
3. 別のクライアントがJOINコマンドで参加するとマッチング成立
4. 両者がPLAYING状態に移行し、ゲーム開始
5. ゲーム中は手番を検証し、合法手のみを適用
6. 勝敗判定後、勝者・敗者に通知

### クライアント (client/client.c)

**役割**: サーバーに接続してゲームをプレイするインターフェース

**主な機能**:
- **サーバー接続**: 指定されたホスト名でサーバーに接続
- **ロビー操作**: ルームの作成・参加、チャット
- **ゲーム表示**: 5×5の盤面とゲーム状態を視覚的に表示
- **手の入力**: ユーザー入力を解析して合法手を送信
- **リアルタイム更新**: 相手の手を受信して盤面を更新

**盤面表示形式**:
```
    a  b  c  d  e
  +--+--+--+--+--+
1 |B#|W |  |  |  |
  +--+--+--+--+--+
2 |  |  |% |  |  |
  +--+--+--+--+--+
...
```

**表記**:
- `B`: 黒の駒（PLAYER_BLACK）
- `W`: 白の駒（PLAYER_WHITE）
- `#`: 黒タイル（TILE_BLACK）
- `%`: グレータイル（TILE_GRAY）
- 空白: 空きマス

**座標系**:
- 列: a～e（左から右）
- 行: 1～5（上から下）
- 例: `a1`は左上、`e5`は右下

**手の入力形式**:

1. **移動のみ**: `<移動元>,<移動先>`
   - 例: `c3,c4` （c3からc4へ駒を移動）

2. **移動+タイル配置**: `<移動元>,<移動先> <タイル位置><タイルの色>`
   - 例: `c3,c4 a1b` （c3からc4へ移動後、a1に黒タイル配置）
   - タイルの色: `b` = 黒（Black）、`g` = グレー（Gray）

**操作の流れ**:
1. クライアント起動: `./client <hostname>`
2. ロビーでルーム作成または参加
   - `LIST`: 待機中のルーム一覧を表示
   - `CREATE 123`: ルームID 123を作成(黒プレイヤーとして待機)
   - `JOIN 123`: ルームID 123に参加(白プレイヤーとして参加)
3. マッチング成立後、盤面が表示される
4. 自分の手番で合法手を入力
5. 相手の手が自動的に反映される
6. 勝敗判定までプレイ
7. `EXIT`: クライアントを終了

## ゲームロジック (core_c/)

**core_cライブラリ**は、Contrastゲームのルールとロジックを提供します。

**主要コンポーネント**:
- `game_state.h/c`: ゲーム状態の管理
- `rules.h/c`: 合法手の生成、勝利条件判定
- `move.h/c`: 手の定義と処理
- `board.h/c`: 盤面データ構造
- `zobrist.h/c`: ゲーム状態のハッシュ計算

## ビルド方法

### 前提条件
- GCC（GNU Compiler Collection）
- Linux環境（ソケット通信のため）
- make

### ビルド手順

1. **全体のビルド** (ルートディレクトリで実行):
```bash
make
```

2. **個別ビルド**:
```bash
# サーバーのみ
cd server
gcc server.c -o server -I../core_c/src/include -L../core_c/build -lcontrast_c

# クライアントのみ
cd client
gcc client.c -o client -I../core_c/src/include -L../core_c/build -lcontrast_c

# core_cライブラリ
cd core_c
make
```

## 実行方法

### 1. サーバーの起動

```bash
cd server
./server
```

サーバーは`0.0.0.0:10000`でリスニングを開始します。

### 2. クライアントの起動（複数ターミナルで実行）

**クライアント1（黒プレイヤー）**:
```bash
cd client
./client localhost
> CREATE 1    # ルームID 1を作成
```

**クライアント2（白プレイヤー）**:
```bash
cd client
./client localhost
> JOIN 1      # ルームID 1に参加
```

### 3. ゲームプレイ

マッチング後、黒プレイヤーから手番が始まります。

**例**:
```
Enter move (e.g. 'c5,c4'): c3,c4
```

タイルを配置する場合:
```
Enter move (e.g. 'c5,c4'): c3,c4 a1b
```

## プロトコル仕様

### クライアント → サーバー

| コマンド | 説明 |
|---------|------|
| `SAY <message>` | ロビーチャット |
| `LIST` | 待機中のルーム一覧を表示 |
| `CREATE <room_id>` | ルーム作成 |
| `JOIN <room_id>` | ルーム参加 |
| `EXIT` | クライアント終了 |

### サーバー → クライアント

| メッセージ | 説明 |
|-----------|------|
| `Welcome! Cmds: ...` | 接続成功 |
| `Room created. Waiting... (You are BLACK)` | ルーム作成完了 |
| `Matched! Start! (You are WHITE)` | マッチング成立 |
| `OPPONENT_MOVE sx sy dx dy place tx ty tile` | 相手の手 |
| `WIN` / `LOSE` | 勝敗通知 |
| `Opponent disconnected. You Win!` | 相手切断による不戦勝 |
| `Error: Room exists.` | エラーメッセージ |

## エラーハンドリング

- **接続失敗**: サーバーが起動していない、またはホスト名が間違っている
- **ルーム重複**: 既に存在するルームIDでCREATEしようとした
- **ルーム未検出**: 存在しないルームIDでJOINしようとした
- **不正な手**: 合法手でない手を入力した場合は拒否される
- **相手の切断**: 対戦中に相手が切断した場合、自動的に勝利

## 技術的特徴

### サーバー側
- **select()による多重化I/O**: 複数の接続を効率的に処理
- **状態遷移管理**: クライアントごとに状態を管理
- **ルーム管理**: 独立したゲーム状態を持つ複数のルームをサポート
- **合法手検証**: サーバー側で手の妥当性を検証
- **SIGPIPEハンドリング**: クライアント切断時のサーバーダウンを防止

### クライアント側
- **非同期入出力**: 標準入力とソケット通信を同時に監視
- **ローカル状態管理**: クライアント側でもゲーム状態を保持
- **ユーザーフレンドリーな入力**: 座標をアルファベット+数字で指定
- **リアルタイム表示**: 盤面を常に最新状態で表示

---

## デバッグとトラブルシューティング

### サーバーが起動しない
- ポート10000が既に使用されていないか確認
- `netstat -tuln | grep 10000` で確認

### クライアントが接続できない
- サーバーが起動しているか確認
- ファイアウォール設定を確認
- localhostまたは正しいIPアドレスを指定

### ゲームが進まない
- 正しい形式で手を入力しているか確認
- 自分の手番かどうか確認（"Waiting for opponent..."表示を確認）
- 合法手リストを確認して入力

### コンパイルエラー
- core_cライブラリが先にビルドされているか確認
- インクルードパスとライブラリパスが正しいか確認
